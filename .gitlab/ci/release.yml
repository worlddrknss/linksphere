# Shared job template: Docker login
.docker-login:
  image: docker:24.0.5
  services:
    - name: docker:24.0.5-dind
      command: ["--tls=false"]
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: tcp://docker:2375
  before_script:
    - echo "üîë Logging into GitLab Container Registry"
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"

# Shared release template
.release-build-template:
  extends: .docker-login
  stage: release
  script:
    - IMAGE_TAG=$(echo "${CI_REGISTRY_IMAGE}/${SERVICE}:${CI_COMMIT_TAG}" | tr '[:upper:]' '[:lower:]')

    - echo "üê≥ Building release image $IMAGE_TAG"
    - docker build -t "$IMAGE_TAG" "$BUILD_PATH"
    - docker push "$IMAGE_TAG"

# Backend release job (tags only)
backend-release:
  extends: .release-build-template
  variables:
    SERVICE: "linksphere-backend"
    BUILD_PATH: "./backend"
  rules:
    - if: '$CI_COMMIT_TAG'

# Frontend release job (tags only)
frontend-release:
  extends: .release-build-template
  variables:
    SERVICE: "linksphere-frontend"
    BUILD_PATH: "./frontend"
  rules:
    - if: '$CI_COMMIT_TAG'

# GitLab Release entry (tags only)
create-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs: [backend-release, frontend-release]
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    - release-cli create --name "Release $CI_COMMIT_TAG" \
        --tag-name "$CI_COMMIT_TAG" \
        --description "Automated release for $CI_COMMIT_TAG"